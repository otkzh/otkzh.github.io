<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gyro Beat - Motion Synth</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            overscroll-behavior: none;
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
            overflow: hidden;
            font-family: 'Courier New', Courier, monospace;
            background-color: #1a1a1a;
            color: white;
        }
        .pulse {
            animation: pulse-anim 0.1s ease-out;
        }
        @keyframes pulse-anim {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- React and ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        const App = () => {
            const [isPlaying, setIsPlaying] = useState(false);
            const [debugInfo, setDebugInfo] = useState({ 
                alpha: 0, beta: 0, gamma: 0, 
                accX: 0, accY: 0, accZ: 0 
            });
            const [bpm, setBpm] = useState(120);
            const [basePitch, setBasePitch] = useState(440);
            const [visualBeat, setVisualBeat] = useState(false);
            const [shakeTriggered, setShakeTriggered] = useState(false);
            const [errorMessage, setErrorMessage] = useState("");
            const [isSecure, setIsSecure] = useState(true);

            // Refs
            const audioCtxRef = useRef(null);
            const nextNoteTimeRef = useRef(0);
            const timerIDRef = useRef(null);
            const bpmRef = useRef(120);
            const pitchRef = useRef(440);
            
            // ÂÆöÊï∞
            const lookahead = 25.0; 
            const scheduleAheadTime = 0.1;

            // Audio Context ÂàùÊúüÂåñ
            const initAudio = () => {
                if (!audioCtxRef.current) {
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    audioCtxRef.current = new AudioContext();
                }
                if (audioCtxRef.current.state === 'suspended') {
                    audioCtxRef.current.resume();
                }
            };

            // „Çª„É≥„Çµ„Éº„ÉÅ„Çß„ÉÉ„ÇØ„Å®ÈñãÂßãÂá¶ÁêÜ
            const requestSensorPermission = async () => {
                initAudio();
                setErrorMessage(""); 

                // HTTPS„ÉÅ„Çß„ÉÉ„ÇØ (localhost‰ª•Â§ñ„Åß„ÅÆhttpÊé•Á∂ö„ÅØË≠¶Âëä)
                const isLocalhost = location.hostname === 'localhost' || location.hostname === '127.0.0.1';
                if (location.protocol !== 'https:' && !isLocalhost) {
                     setErrorMessage("‚ö†Ô∏è Ê≥®ÊÑè: HTTPÊé•Á∂ö„Åß„ÅØ„Çª„É≥„Çµ„Éº„ÅåÁÑ°ÂäπÂåñ„Åï„Çå„ÇãÂèØËÉΩÊÄß„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇHTTPSÊé•Á∂ö„ÇíÊé®Â•®„Åó„Åæ„Åô„ÄÇ");
                     setIsSecure(false);
                     // Âº∑Âà∂ÁöÑ„Å´„Çπ„Çø„Éº„Éà„Åï„Åõ„ÇãÔºà„Çø„ÉÉ„ÉÅÊìç‰Ωú„ÅÆ„Åü„ÇÅÔºâ
                     startSensors(); 
                     return;
                }

                // iOS 13+ „ÅÆÂ†¥Âêà
                if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                    try {
                        const response = await DeviceMotionEvent.requestPermission();
                        if (response === 'granted') {
                            startSensors();
                        } else {
                            setErrorMessage("„Çª„É≥„Çµ„Éº„ÅÆË®±ÂèØ„ÅåÊãíÂê¶„Åï„Çå„Åæ„Åó„Åü„ÄÇ„Çø„ÉÉ„ÉÅÊìç‰Ωú„ÅÆ„ÅøÊúâÂäπ„Åß„Åô„ÄÇ");
                            startSensors(); // „Çø„ÉÉ„ÉÅÊìç‰ΩúÁî®„Å´Ëµ∑Âãï
                        }
                    } catch (e) {
                        console.error(e);
                        setErrorMessage("„Çª„É≥„Çµ„ÉºË®±ÂèØ„Ç®„É©„Éº: " + e.message);
                        startSensors();
                    }
                } else {
                    // Android „Åæ„Åü„ÅØ Âè§„ÅÑiOS
                    startSensors();
                }
            };

            const startSensors = () => {
                window.removeEventListener('deviceorientation', handleOrientation);
                window.removeEventListener('devicemotion', handleMotion);

                window.addEventListener('deviceorientation', handleOrientation);
                window.addEventListener('devicemotion', handleMotion);
                
                setIsPlaying(true);
                if (audioCtxRef.current) {
                    nextNoteTimeRef.current = audioCtxRef.current.currentTime;
                }
                scheduler();
            };

            const stopSensors = () => {
                window.removeEventListener('deviceorientation', handleOrientation);
                window.removeEventListener('devicemotion', handleMotion);
                setIsPlaying(false);
                clearTimeout(timerIDRef.current);
            };

            // ÂÄ§„ÅÆÂèçÊò†Âá¶ÁêÜÔºà„Çª„É≥„Çµ„Éº„Éª„Çø„ÉÉ„ÉÅÂÖ±ÈÄöÔºâ
            const updateParams = (beta, gamma) => {
                // UIË°®Á§∫Êõ¥Êñ∞
                setDebugInfo(prev => ({
                    ...prev,
                    beta: Math.round(beta),
                    gamma: Math.round(gamma)
                }));

                // Ë®àÁÆó„É≠„Ç∏„ÉÉ„ÇØ
                // „ÉÜ„É≥„Éù (Gamma - Â∑¶Âè≥): -45 ~ 45 -> 60 ~ 300 BPM
                const clampedGamma = Math.max(-45, Math.min(45, gamma));
                const newBpm = Math.floor(((clampedGamma + 45) / 90) * 240 + 60);
                
                // Èü≥Á®ã (Beta - ÂâçÂæå): -45 ~ 45 -> 100 ~ 800 Hz
                const clampedBeta = Math.max(-45, Math.min(45, beta)); 
                const newPitch = Math.floor(((clampedBeta + 45) / 90) * 700 + 100);

                // RefÊõ¥Êñ∞ÔºàÈü≥Â£∞„É´„Éº„ÉóÁî®Ôºâ
                bpmRef.current = newBpm;
                pitchRef.current = newPitch;

                // StateÊõ¥Êñ∞ÔºàUIË°®Á§∫Áî®Ôºâ
                setBpm(newBpm);
                setBasePitch(newPitch);
            }

            // „Ç∏„É£„Ç§„É≠„Çª„É≥„Çµ„Éº„Éè„É≥„Éâ„É©
            const handleOrientation = (event) => {
                if (event.beta === null || event.gamma === null) return;
                
                // alpha„ÇÇ„Éá„Éê„ÉÉ„Ç∞Ë°®Á§∫Áî®„Å´Êõ¥Êñ∞
                setDebugInfo(prev => ({ ...prev, alpha: Math.round(event.alpha || 0) }));
                
                updateParams(event.beta, event.gamma);
            };

            // „Çø„ÉÉ„ÉÅ/„Éû„Ç¶„ÇπÊìç‰Ωú„Éè„É≥„Éâ„É©Ôºà„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÁî®Ôºâ
            const handlePointerMove = (e) => {
                if (!isPlaying) return;
                
                // ÁîªÈù¢‰∏≠Â§Æ„ÇíÂéüÁÇπ(0,0)„Å®„Åó„ÄÅÁ´Ø„Å´Ë°å„Åè„Åª„Å©ÂÇæ„Åç(¬±45Â∫¶)„Å®„Åô„Çã
                const centerX = window.innerWidth / 2;
                const centerY = window.innerHeight / 2;
                
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;

                // XËª∏ -> Gamma (Â∑¶Âè≥)
                const xRate = (clientX - centerX) / centerX; // -1 ~ 1
                const gamma = xRate * 45;

                // YËª∏ -> Beta (‰∏ä‰∏ã)
                // ‰∏ä„Å´Ë°å„Åè„Å®„Éî„ÉÉ„ÉÅ„Çí‰∏ä„Åí„Åü„ÅÑ„ÅÆ„Åß„ÄÅY„ÅåÂ∞è„Åï„ÅÑ(‰∏ä)„Åª„Å©ÂÄ§„ÇíÂ§ß„Åç„Åè„Åô„Çã„Å™„ÇâÂèçËª¢„Åï„Åõ„Çã„Åå„ÄÅ
                // „Çª„É≥„Çµ„Éº„Åß„ÅØ„ÄåÊâãÂâç„Å´ÂÇæ„Åë„Çã(BetaÂ¢ó)„Äç„ÄåÂ••„Å´ÂÄí„Åô(BetaÊ∏õ)„ÄçÁ≠â„ÅÆÊÑüË¶ö„Å´„Çà„Çã„ÄÇ
                // „Åì„Åì„Åß„ÅØÁîªÈù¢‰∏äÔºù„Éî„ÉÉ„ÉÅÈ´ò„ÄÅÁîªÈù¢‰∏ãÔºù„Éî„ÉÉ„ÉÅ‰Ωé„Å®„Åô„Çã„ÄÇ
                const yRate = (centerY - clientY) / centerY; // -1(‰∏ã) ~ 1(‰∏ä)
                const beta = yRate * 45;

                updateParams(beta, gamma);
            };

            // „ÇØ„É™„ÉÉ„ÇØ„Åß„Ç∑„Çß„Ç§„ÇØ‰ª£„Çè„Çä
            const handlePointerClick = () => {
                if(!isPlaying) return;
                triggerShakeSound();
                setShakeTriggered(true);
                setTimeout(() => setShakeTriggered(false), 200);
            };

            // Âä†ÈÄüÂ∫¶„Çª„É≥„Çµ„Éº„Éè„É≥„Éâ„É©
            const handleMotion = (event) => {
                if (!event.acceleration) return;
                const { x, y, z } = event.acceleration;

                setDebugInfo(prev => ({
                    ...prev,
                    accX: x ? x.toFixed(1) : 0,
                    accY: y ? y.toFixed(1) : 0,
                    accZ: z ? z.toFixed(1) : 0
                }));

                const magnitude = Math.sqrt((x||0)**2 + (y||0)**2 + (z||0)**2);
                if (magnitude > 25) {
                    if (!shakeTriggered) {
                        triggerShakeSound();
                        setShakeTriggered(true);
                        setTimeout(() => setShakeTriggered(false), 200);
                    }
                }
            };

            // --- Èü≥Â£∞ÂêàÊàê„Ç®„É≥„Ç∏„É≥ ---

            const playBeatSound = (time, freq) => {
                if (!audioCtxRef.current) return;
                const osc = audioCtxRef.current.createOscillator();
                const gainNode = audioCtxRef.current.createGain();

                osc.connect(gainNode);
                gainNode.connect(audioCtxRef.current.destination);

                osc.frequency.setValueAtTime(freq, time);
                osc.frequency.exponentialRampToValueAtTime(Math.max(10, freq * 0.1), time + 0.1);

                gainNode.gain.setValueAtTime(0.8, time);
                gainNode.gain.exponentialRampToValueAtTime(0.001, time + 0.15);

                osc.start(time);
                osc.stop(time + 0.15);
            };

            const triggerShakeSound = () => {
                if (!audioCtxRef.current) return;
                const time = audioCtxRef.current.currentTime;
                
                const bufferSize = audioCtxRef.current.sampleRate * 0.5;
                const buffer = audioCtxRef.current.createBuffer(1, bufferSize, audioCtxRef.current.sampleRate);
                const data = buffer.getChannelData(0);
                for (let i = 0; i < bufferSize; i++) {
                    data[i] = Math.random() * 2 - 1;
                }

                const noise = audioCtxRef.current.createBufferSource();
                noise.buffer = buffer;
                
                const gainNode = audioCtxRef.current.createGain();
                const filter = audioCtxRef.current.createBiquadFilter();
                filter.type = "highpass";
                filter.frequency.value = 800;

                noise.connect(filter);
                filter.connect(gainNode);
                gainNode.connect(audioCtxRef.current.destination);

                gainNode.gain.setValueAtTime(0.8, time);
                gainNode.gain.exponentialRampToValueAtTime(0.001, time + 0.3);

                noise.start(time);
            };

            // --- „Çπ„Ç±„Ç∏„É•„Éº„É™„É≥„Ç∞ ---

            const nextNote = () => {
                const secondsPerBeat = 60.0 / bpmRef.current;
                nextNoteTimeRef.current += secondsPerBeat;
            };

            const scheduleNote = (time) => {
                playBeatSound(time, pitchRef.current);
                
                const delay = (time - audioCtxRef.current.currentTime) * 1000;
                setTimeout(() => {
                    setVisualBeat(true);
                    setTimeout(() => setVisualBeat(false), 80);
                }, Math.max(0, delay));
            };

            const scheduler = () => {
                if (!audioCtxRef.current) return;
                while (nextNoteTimeRef.current < audioCtxRef.current.currentTime + scheduleAheadTime) {
                    scheduleNote(nextNoteTimeRef.current);
                    nextNote();
                }
                timerIDRef.current = setTimeout(scheduler, lookahead);
            };

            useEffect(() => {
                return () => stopSensors();
            }, []);

            const getBackgroundColor = () => {
                if (shakeTriggered) return 'white';
                const hue = Math.min(360, Math.max(0, ((basePitch - 100) / 700) * 360));
                const lightness = visualBeat ? 60 : 20; 
                return `hsl(${hue}, 70%, ${lightness}%)`;
            };

            return (
                <div 
                    className="w-full h-screen flex flex-col items-center justify-between overflow-hidden transition-colors duration-75"
                    style={{ backgroundColor: isPlaying ? getBackgroundColor() : '#222' }}
                    onTouchMove={handlePointerMove}
                    onMouseMove={handlePointerMove}
                    onClick={handlePointerClick}
                >
                    {/* --- „Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†± --- */}
                    <div className="absolute top-0 left-0 w-full p-2 z-50 pointer-events-none">
                        <div className="bg-black/40 backdrop-blur-sm text-green-400 font-mono text-xs p-2 rounded max-w-full overflow-hidden border border-green-500/20">
                            <div className="grid grid-cols-2 gap-x-4">
                                <span>ALPHA (Z): {debugInfo.alpha}</span>
                                <span>ACC-X: {debugInfo.accX}</span>
                                <span>BETA  (Y): {debugInfo.beta}</span>
                                <span>ACC-Y: {debugInfo.accY}</span>
                                <span>GAMMA (X): {debugInfo.gamma}</span>
                                <span>ACC-Z: {debugInfo.accZ}</span>
                            </div>
                            <div className="mt-1 border-t border-green-400/30 pt-1 text-white">
                                BPM: {bpm} | PITCH: {basePitch}Hz
                            </div>
                            {!isSecure && <div className="text-red-400 mt-1 font-bold">! NON-SECURE: SENSORS BLOCKED !</div>}
                        </div>
                    </div>

                    {!isPlaying ? (
                        <div className="flex-1 flex flex-col items-center justify-center p-6 text-center z-10 w-full max-w-md pointer-events-none">
                            <div className="pointer-events-auto bg-gray-800/90 backdrop-blur p-6 rounded-xl border border-gray-600 w-full shadow-2xl">
                                <h1 className="text-4xl font-bold text-white mb-2 tracking-tighter" style={{ textShadow: '0 0 20px cyan' }}>GYRO BEAT</h1>
                                <p className="text-gray-300 text-sm mb-4">
                                    Motion Synthesizer
                                </p>
                                
                                {errorMessage && (
                                    <div className="bg-orange-500/20 text-orange-200 border border-orange-500/50 p-3 rounded text-xs mb-4 text-left">
                                        {errorMessage}
                                        <div className="mt-1 text-white underline decoration-dashed">
                                            ‚Äª ‰ª£„Çè„Çä„Å´ÁîªÈù¢„Çø„ÉÉ„ÉÅ„Åß„ÇÇÊìç‰ΩúÂèØËÉΩ„Åß„Åô
                                        </div>
                                    </div>
                                )}
                                
                                <button 
                                    onClick={(e) => { e.stopPropagation(); requestSensorPermission(); }}
                                    className="w-full bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-4 rounded-lg shadow-lg text-lg transition-transform active:scale-95"
                                >
                                    START
                                </button>
                                
                                <p className="text-xs text-gray-500 mt-4">
                                    Êé®Â•®Áí∞Â¢É: Android/iOS (HTTPSÊé•Á∂ö)<br/>
                                    ÈùûÂØæÂøúÁí∞Â¢É„Åß„ÅØ„Çø„ÉÉ„ÉÅÊìç‰Ωú„ÅåÊúâÂäπ„Å´„Å™„Çä„Åæ„Åô
                                </p>
                            </div>
                        </div>
                    ) : (
                        <div className="flex-1 w-full flex flex-col items-center justify-center relative pointer-events-none">
                            {/* ‰∏≠Â§Æ„Éì„Ç∏„É•„Ç¢„É´ */}
                            <div className={`transition-transform duration-75 ${visualBeat ? 'scale-125' : 'scale-100'}`}>
                                <div className={`w-40 h-40 rounded-full border-4 flex items-center justify-center transition-colors ${shakeTriggered ? 'bg-white border-white' : 'bg-transparent border-white/50'}`}>
                                    <span className="text-4xl">{shakeTriggered ? '‚ö°Ô∏è' : 'üéµ'}</span>
                                </div>
                            </div>

                            <div className="absolute bottom-24 w-full text-center px-4">
                                <p className="text-white/60 text-sm font-bold bg-black/20 inline-block px-3 py-1 rounded-full backdrop-blur">
                                    {isSecure ? "„Çπ„Éû„Éõ„ÇíÂÇæ„Åë„Å¶Êìç‰Ωú" : "üëÜ ÁîªÈù¢„Çí„Å™„Åû„Å£„Å¶Êìç‰Ωú („Çª„É≥„Çµ„ÉºÁÑ°Âäπ)"}
                                </p>
                            </div>

                            <button 
                                onClick={(e) => { e.stopPropagation(); stopSensors(); }}
                                className="pointer-events-auto absolute bottom-8 bg-red-500/80 hover:bg-red-500 text-white text-sm px-8 py-3 rounded-full backdrop-blur-md shadow-lg font-bold"
                            >
                                STOP
                            </button>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>